services:
  web:
    image: php:${VERSION:-latest}
    container_name: ${CONTAINER_NAME:-PHP}
    restart: ${RESTART:-always}
    environment:
      PHP_EXTENSIONS: ${PHP_EXTENSIONS:-}
      PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT:-}
      APACHE_SERVER_NAME: ${APACHE_SERVER_NAME:-localhost}
    ports:
      - "${PORT:-8081}:80"
    volumes:
      - ${PHP_WEB_ROOT:-./app}:/var/www/html
    command: >
      /bin/bash -c "
      if [ -n $${PHP_EXTENSIONS+x} ]; then
        docker-php-ext-install $$PHP_EXTENSIONS || exit 1;
      fi &&
      if ! grep -q 'ServerName' /etc/apache2/apache2.conf; then
        echo 'ServerName $$APACHE_SERVER_NAME' >> /etc/apache2/apache2.conf;
      else
        sed -i 's/^ServerName .*/ServerName $$APACHE_SERVER_NAME/' /etc/apache2/apache2.conf;
      fi;
      apache2-foreground"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${CONTAINER_NAME:-PHP}.rule=Host(`${APACHE_SERVER_NAME:-localhost}`)"
      - "traefik.http.routers.${CONTAINER_NAME:-PHP}.entrypoints=web,websecure"
      - "traefik.http.routers.${CONTAINER_NAME:-PHP}.tls=true"
      - "traefik.http.routers.${CONTAINER_NAME:-PHP}.tls.certresolver=production"
    networks:
      - traefik

# NOTE: =====CLOUDFLARE=====: You will need to TEMPORARILY DISABLE SSL/TLS AND the https upgrade
#       in ../traefik/config/traefik.yml in order to pass the ACME challenge. Review the log file
#       ../traefik/config/logs/traefik/traefik.log to determine success. After the LetsEncrpt cert
#       has been issued, you will get TOO MANY REDIRECTS (https) AND 404 Not Found (http) until
#       you re-enable SSL/TLS. For Cloudflare setups, you don't need to use the traefik.yml https
#       redirect - instead use the setting in the "Edge Certificates" subsection under "SSL/TLS"
#       *ALSO* You don't need to disable proxying the origin server IP at any time (leave on).
#
#       ======GODADDY======: No additional configuration needed as godaddy does not handle edge
#       certificates - you can use the traefik.yml https redirect but should note that this would
#       potentially break the ACME challenge for new domains that use Cloudflare. Redirecting in
#       the application layer is preferred.

networks:
  traefik:
    external: true
